version: 2.1

commands:
  setup:
    steps:
      - run: |
          wget -O hugo.tgz https://github.com/gohugoio/hugo/releases/download/v0.49.2/hugo_0.49.2_Linux-64bit.tar.gz \
            && tar xzvf hugo.tgz \
            && mv ./hugo /usr/local/bin/hugo \
            && apk update \
            && apk add --no-cache make imagemagick git bash pngquant file jpegoptim

executors:
  builder:
    working_directory: /app
    docker:
      - image: alpine:3.8
        environment:
          TZ: Asia/Tokyo
  deployer:
    working_directory: /app
    docker:
      - image: node:10
        environment:
          TZ: Asia/Tokyo

jobs:
  build:
    executor: builder
    steps:
      - checkout
      - setup
      - run:
          name: Update submodule
          command: |
            git submodule init
            git submodule update --remote
      - run:
          name: Build site
          command: make build
      - persist_to_workspace:
          root: .
          paths:
            - public/*

  deploy:
    executor: deployer
    steps:
      - run:
          name: Install firebase-tools
          command: npm install -g firebase-tools
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Deploy to Firebase
          command: firebase deploy -p ./public --token "$FIREBASE_TOKEN"

workflows:
  build_and_deploy:
    jobs:
      - build
      - deploy:
          requires: [build]
  daily_deploy:
    triggers:
      - schedule:
          cron: "00 16 * * *"
          filters:
            branches:
              only: [master]
    jobs:
      - build
      - deploy:
          requires: [build]
